import{P as ie}from"./chunk-2LPGQWPV-BmYXjAp4.js";import{j as e,r as I,b as A,aw as ae,ax as le,aq as V,es as oe,t as G,B as D,aB as U,e7 as K,as as F,at as $,K as ce,H as ne,a1 as q,I as t,J as de,ap as _,G as E,co as W,W as ue,cI as pe,Z as me,_ as xe,E as O,f as Y,k as he,g as fe,a0 as X}from"./index-Dj5zw04S.js";import{u as ge,P as je,a as be,b as ve}from"./chunk-FPJBF7VS-BsPNgyVF.js";import{e as ye,i as Pe}from"./chunk-G2J2T2QU-Cd5BPMfY.js";import{u as Ce,a as Se}from"./chunk-PCFUZKDS-BvyyVopc.js";import{u as Le,_ as _e}from"./chunk-7VJK6HNE-BQPIF-4U.js";import{D as we}from"./chunk-UWJBDOQD-z3y1saKn.js";import{u as Ne}from"./chunk-Y4YXZY7R-DSY-7lUj.js";import"./chunk-Z26G6WFJ-TYOJ6Vm1.js";import{K as Te}from"./chunk-6HTZNHPT-fV5RBr_f.js";import{R as w,u as ee,a as Fe,S as T}from"./chunk-4TC5YS65-Do6_f7wk.js";import{P}from"./progress-tabs-CFITYrEv.js";import{R as H}from"./radio-group-DrG7Xrne.js";import{T as Ie}from"./textarea-YkRIaWpI.js";import"./chunk-ZJRFL6ZN-CHL_M8UD.js";import"./chunk-C76H5USB-C3dh0QkI.js";import"./chunk-MSDRGCRR-BExq9JDw.js";import"./chunk-P3UUX2T6-BVTrmrYj.js";import"./chunk-6GU6IDUA-CDc7wW5L.js";import"./chunk-XLDQPLK4-Db6-i0AQ.js";import"./chunk-ADOCJB6L-C7LcHKzS.js";import"./chunk-IQBAUTU5-CLqhW2nM.js";import"./chunk-YEDAFXMB-Bd00Mpl-.js";import"./chunk-M3VFKDXJ-ClKDF7xd.js";import"./chunk-AOFGTNG6-rbpG6niP.js";import"./chunk-EMIHDNB7-No65am7K.js";import"./chunk-DK4WIVY6-CYCbBMOO.js";import"./_isIndex-DSnlKWbI.js";import"./chunk-PFKKVLZX-DkaIYb50.js";import"./index-d9ruMJpF.js";var Re=({form:a})=>{const{t:s}=A(),{fields:o,remove:c,append:f}=ce({control:a.control,name:"rules.customer_group_id",keyName:"cg_id"}),{setIsOpen:g}=Fe(),p=l=>{const x=l.map(h=>h.id),n=l.filter(h=>!o.some(b=>b.id===h.id));for(const h of o)x.includes(h.id)||c(o.indexOf(h));f(n),g("cg",!1)};return e.jsx("div",{className:"flex flex-1 flex-col items-center overflow-y-auto",children:e.jsxs("div",{className:"flex w-full max-w-[720px] flex-col gap-y-8 px-8 py-16",children:[e.jsxs("div",{children:[e.jsx(ne,{children:s("priceLists.create.header")}),e.jsx(q,{size:"small",className:"text-ui-fg-subtle",children:s("priceLists.create.subheader")})]}),e.jsx(t.Field,{control:a.control,name:"type",render:({field:{onChange:l,...x}})=>e.jsxs(t.Item,{children:[e.jsxs("div",{className:"flex flex-col gap-y-4",children:[e.jsxs("div",{children:[e.jsx(t.Label,{children:s("priceLists.fields.type.label")}),e.jsx(t.Hint,{children:s("priceLists.fields.type.hint")})]}),e.jsx(t.Control,{children:e.jsxs(H,{onValueChange:l,...x,className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsx(H.ChoiceBox,{value:"sale",label:s("priceLists.fields.type.options.sale.label"),description:s("priceLists.fields.type.options.sale.description")}),e.jsx(H.ChoiceBox,{value:"override",label:s("priceLists.fields.type.options.override.label"),description:s("priceLists.fields.type.options.override.description")})]})})]}),e.jsx(t.ErrorMessage,{})]})}),e.jsxs("div",{className:"flex flex-col gap-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1  gap-4 md:grid-cols-2",children:[e.jsx(t.Field,{control:a.control,name:"title",render:({field:l})=>e.jsxs(t.Item,{children:[e.jsx(t.Label,{children:s("fields.title")}),e.jsx(t.Control,{children:e.jsx(de,{...l})}),e.jsx(t.ErrorMessage,{})]})}),e.jsx(t.Field,{control:a.control,name:"status",render:({field:{onChange:l,ref:x,...n}})=>e.jsxs(t.Item,{children:[e.jsx(t.Label,{children:s("priceLists.fields.status.label")}),e.jsx(t.Control,{children:e.jsxs(_,{...n,onValueChange:l,children:[e.jsx(_.Trigger,{ref:x,children:e.jsx(_.Value,{})}),e.jsxs(_.Content,{children:[e.jsx(_.Item,{value:"active",children:s("priceLists.fields.status.options.active")}),e.jsx(_.Item,{value:"draft",children:s("priceLists.fields.status.options.draft")})]})]})}),e.jsx(t.ErrorMessage,{})]})})]}),e.jsx(t.Field,{control:a.control,name:"description",render:({field:l})=>e.jsxs(t.Item,{children:[e.jsx(t.Label,{children:s("fields.description")}),e.jsx(t.Control,{children:e.jsx(Ie,{...l})}),e.jsx(t.ErrorMessage,{})]})})]}),e.jsx(E,{}),e.jsx(t.Field,{control:a.control,name:"starts_at",render:({field:l})=>e.jsxs(t.Item,{children:[e.jsxs("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-2",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx(t.Label,{optional:!0,children:s("priceLists.fields.startsAt.label")}),e.jsx(t.Hint,{children:s("priceLists.fields.startsAt.hint")})]}),e.jsx(t.Control,{children:e.jsx(W,{granularity:"minute",shouldCloseOnSelect:!1,...l})})]}),e.jsx(t.ErrorMessage,{})]})}),e.jsx(E,{}),e.jsx(t.Field,{control:a.control,name:"ends_at",render:({field:l})=>e.jsxs(t.Item,{children:[e.jsxs("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-2",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx(t.Label,{optional:!0,children:s("priceLists.fields.endsAt.label")}),e.jsx(t.Hint,{children:s("priceLists.fields.endsAt.hint")})]}),e.jsx(t.Control,{children:e.jsx(W,{granularity:"minute",shouldCloseOnSelect:!1,...l})})]}),e.jsx(t.ErrorMessage,{})]})}),e.jsx(E,{}),e.jsx(t.Field,{control:a.control,name:"rules.customer_group_id",render:({field:l})=>e.jsxs(t.Item,{children:[e.jsxs("div",{children:[e.jsx(t.Label,{optional:!0,children:s("priceLists.fields.customerAvailability.label")}),e.jsx(t.Hint,{children:s("priceLists.fields.customerAvailability.hint")})]}),e.jsx(t.Control,{children:e.jsxs("div",{className:ue("bg-ui-bg-component shadow-elevation-card-rest transition-fg grid gap-1.5 rounded-xl py-1.5","aria-[invalid='true']:shadow-borders-error"),role:"application",ref:l.ref,children:[e.jsxs("div",{className:"text-ui-fg-subtle grid gap-1.5 px-1.5 md:grid-cols-2",children:[e.jsx("div",{className:"bg-ui-bg-field shadow-borders-base txt-compact-small rounded-md px-2 py-1.5",children:s("priceLists.fields.customerAvailability.attribute")}),e.jsx("div",{className:"bg-ui-bg-field shadow-borders-base txt-compact-small rounded-md px-2 py-1.5",children:s("operators.in")})]}),e.jsx("div",{className:"flex items-center gap-1.5 px-1.5",children:e.jsxs(T,{id:"cg",children:[e.jsx(T.Trigger,{asChild:!0,children:e.jsxs("button",{type:"button",className:"bg-ui-bg-field-component hover:bg-ui-bg-field-component-hover shadow-borders-base txt-compact-small text-ui-fg-muted transition-fg focus-visible:shadow-borders-interactive-with-active flex flex-1 items-center gap-x-2 rounded-md px-2 py-1.5 outline-none",children:[e.jsx(pe,{}),s("priceLists.fields.customerAvailability.placeholder")]})}),e.jsx(T.Trigger,{asChild:!0,children:e.jsx(D,{variant:"secondary",children:s("actions.browse")})}),e.jsxs(T.Content,{children:[e.jsx(T.Header,{}),e.jsx(ie,{state:o,setState:p,type:"focus"})]})]})}),o.length>0?e.jsxs("div",{className:"flex flex-col gap-y-1.5",children:[e.jsx(E,{variant:"dashed"}),e.jsx("div",{className:"flex flex-col gap-y-1.5 px-1.5",children:o.map((x,n)=>e.jsxs("div",{className:"bg-ui-bg-field-component shadow-borders-base flex items-center justify-between gap-2 rounded-md px-2 py-0.5",children:[e.jsx(q,{size:"small",leading:"compact",children:x.name}),e.jsx(me,{size:"small",variant:"transparent",type:"button",onClick:()=>c(n),children:e.jsx(xe,{})})]},x.cg_id))})]}):null]})}),e.jsx(t.ErrorMessage,{})]})})]})})},ke=({form:a,currencies:s,regions:o,pricePreferences:c})=>{const f=O({control:a.control,name:"product_ids"}),g=O({control:a.control,name:"products"}),{products:p,isLoading:l,isError:x,error:n}=Y({id:f.map(u=>u.id),limit:f.length,fields:"title,thumbnail,*variants"}),{setCloseOnEscape:h}=ee(),{setValue:b}=a;I.useEffect(()=>{!l&&p&&p.forEach(u=>{g[u.id]||!u.variants||b(`products.${u.id}.variants`,{...u.variants.reduce((S,L)=>(S[L.id]={currency_prices:{},region_prices:{}},S),{})})})},[p,g,l,b]);const N=ve({currencies:s,regions:o,pricePreferences:c});if(x)throw n;return e.jsx("div",{className:"flex size-full flex-col divide-y overflow-hidden",children:e.jsx(we,{isLoading:l,columns:N,data:p,getSubRows:u=>{if(Pe(u)&&u.variants)return u.variants},state:a,onEditingChange:u=>h(!u)})})},B=50,Z="p";function Ee(a){return a.reduce((s,o)=>(s[o.id]=!0,s),{})}var De=({form:a})=>{const{t:s}=A(),{control:o,setValue:c}=a,f=O({control:o,name:"product_ids"}),g=O({control:o,name:"products"}),[p,l]=I.useState(Ee(f)),{searchParams:x,raw:n}=Ce({pageSize:B,prefix:Z}),{products:h,count:b,isLoading:N,isError:u,error:S}=Y(x,{placeholderData:he}),L=r=>{const d=typeof r=="function"?r(p):r,v=Object.keys(d),j=Object.keys(g).reduce((k,z)=>(v.includes(z)&&(k[z]=g[z]),k),{}),re=v.map(k=>({id:k}));c("product_ids",re,{shouldDirty:!0,shouldTouch:!0}),c("products",j,{shouldDirty:!0,shouldTouch:!0}),l(d)},R=Ae(),i=Ne(),{table:m}=Le({data:h||[],columns:R,count:b,enablePagination:!0,enableRowSelection:r=>{var d;return!!((d=r.original.variants)!=null&&d.length)},getRowId:r=>r.id,rowSelection:{state:p,updater:L},pageSize:B});if(u)throw S;return e.jsx("div",{className:"flex size-full flex-col",children:e.jsx(_e,{table:m,columns:R,filters:i,pageSize:B,prefix:Z,count:b,isLoading:N,layout:"fill",orderBy:[{key:"title",label:s("fields.title")},{key:"status",label:s("fields.status")},{key:"created_at",label:s("fields.createdAt")},{key:"updated_at",label:s("fields.updatedAt")}],pagination:!0,search:!0,queryObject:n,noRecords:{message:s("priceLists.create.products.list.noRecordsMessage")}})})},Oe=fe(),Ae=()=>{const a=Se();return I.useMemo(()=>[Oe.display({id:"select",header:({table:s})=>e.jsx(X,{checked:s.getIsSomePageRowsSelected()?"indeterminate":s.getIsAllPageRowsSelected(),onCheckedChange:o=>s.toggleAllPageRowsSelected(!!o)}),cell:({row:s})=>e.jsx(X,{checked:s.getIsSelected(),disabled:!s.getCanSelect(),onCheckedChange:o=>s.toggleSelected(!!o),onClick:o=>{o.stopPropagation()}})}),...a],[a])};U(V({id:F(),name:F()}));var M=V({type:$(["sale","override"]),status:$(["draft","active"]),title:F().min(1),description:F().min(1),starts_at:K().nullish(),ends_at:K().nullish(),product_ids:U(V({id:F()})).min(1),products:be,rules:je.nullish()}),se=M.pick({type:!0,title:!0,description:!0,starts_at:!0,ends_at:!0,customer_group_ids:!0}),J=Object.keys(se.shape),te=M.pick({product_ids:!0}),Q=Object.keys(te.shape),Me=M.pick({products:!0}),ze=Object.keys(Me.shape),C=["detail","product","price"],He={detail:"in-progress",product:"not-started",price:"not-started"},Be=({regions:a,currencies:s,pricePreferences:o})=>{const[c,f]=I.useState("detail"),[g,p]=I.useState(He),{t:l}=A(),{handleSuccess:x}=ee(),n=ae({defaultValues:{type:"sale",status:"active",title:"",description:"",starts_at:null,ends_at:null,product_ids:[],products:{},rules:{customer_group_id:[]}},resolver:le(M)}),{mutateAsync:h,isPending:b}=oe(),N=n.handleSubmit(async i=>{var y;const{rules:m,products:r}=i,d=(y=m==null?void 0:m.customer_group_id)!=null&&y.length?{"customer.groups.id":m.customer_group_id.map(j=>j.id)}:void 0,v=ye(r,a);await h({title:i.title,type:i.type,status:i.status,description:i.description,starts_at:i.starts_at?i.starts_at.toISOString():null,ends_at:i.ends_at?i.ends_at.toISOString():null,rules:d,prices:v},{onSuccess:({price_list:j})=>{G.success(l("priceLists.create.successToast",{title:j.title})),x(`../${j.id}`)},onError:j=>{G.error(j.message)}})}),u=(i,m)=>{n.clearErrors(i);const r=i.reduce((v,y)=>(v[y]=n.getValues(y),v),{}),d=m.safeParse(r);return d.success?!0:(d.error.errors.forEach(({path:v,message:y,code:j})=>{n.setError(v.join("."),{type:j,message:y})}),!1)},S=i=>{switch(i){case"detail":return J.some(r=>n.getFieldState(r).isDirty);case"product":return Q.some(r=>n.getFieldState(r).isDirty);case"price":return ze.some(r=>n.getFieldState(r).isDirty)}},L=i=>{if(c===i)return;if(C.indexOf(i)<C.indexOf(c)){const r=S(c);p(d=>({...d,[c]:r?d[c]:"not-started",[i]:"in-progress"})),f(i);return}const m=C.slice(0,C.indexOf(i));for(const r of m)if(r==="detail"){if(!u(J,se)){p(d=>({...d,[r]:"in-progress"})),f(r);return}p(d=>({...d,[r]:"completed"}))}else if(r==="product"){if(!u(Q,te)){p(d=>({...d,[r]:"in-progress"})),f(r);return}p(d=>({...d,[r]:"completed"}))}p(r=>({...r,[c]:"completed",[i]:"in-progress"})),f(i)},R=i=>{if(C.indexOf(i)+1>=C.length)return;const m=C[C.indexOf(i)+1];L(m)};return e.jsx(w.Form,{form:n,children:e.jsx(P,{value:c,onValueChange:i=>L(i),className:"flex h-full flex-col overflow-hidden",children:e.jsxs(Te,{onSubmit:N,className:"flex h-full flex-col",children:[e.jsx(w.Header,{children:e.jsx("div",{className:"flex w-full items-center justify-between gap-x-4",children:e.jsx("div",{className:"-my-2 w-full max-w-[600px] border-l",children:e.jsxs(P.List,{className:"grid w-full grid-cols-3",children:[e.jsx(P.Trigger,{status:g.detail,value:"detail",children:l("priceLists.create.tabs.details")}),e.jsx(P.Trigger,{status:g.product,value:"product",children:l("priceLists.create.tabs.products")}),e.jsx(P.Trigger,{status:g.price,value:"price",children:l("priceLists.create.tabs.prices")})]})})})}),e.jsxs(w.Body,{className:"size-full overflow-hidden",children:[e.jsx(P.Content,{className:"size-full overflow-y-auto",value:"detail",children:e.jsx(Re,{form:n})}),e.jsx(P.Content,{className:"size-full overflow-y-auto",value:"product",children:e.jsx(De,{form:n})}),e.jsx(P.Content,{className:"size-full overflow-hidden",value:"price",children:e.jsx(ke,{form:n,regions:a,currencies:s,pricePreferences:o})})]}),e.jsx(w.Footer,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(w.Close,{asChild:!0,children:e.jsx(D,{variant:"secondary",size:"small",children:l("actions.cancel")})}),e.jsx(Ve,{tab:c,next:R,isLoading:b})]})})]})})})},Ve=({tab:a,next:s,isLoading:o})=>{const{t:c}=A();return a==="price"?e.jsx(D,{type:"submit",variant:"primary",size:"small",isLoading:o,children:c("actions.save")},"submit-button"):e.jsx(D,{type:"button",variant:"primary",size:"small",onClick:()=>s(a),children:c("actions.continue")},"next-button")},bs=()=>{const{isReady:a,regions:s,currencies:o,pricePreferences:c}=ge();return e.jsx(w,{children:a&&e.jsx(Be,{regions:s,currencies:o,pricePreferences:c})})};export{bs as Component};
