import{u as re,b as M,S as ie,C as ne,U as D}from"./chunk-O74UDEWT-CPxok9MZ.js";import{C as O,R as P,I}from"./chunk-PYIO3TDQ-D8Zv8hXV.js";import{D as oe}from"./chunk-UWJBDOQD-z3y1saKn.js";import{c as R}from"./chunk-6GU6IDUA-CDc7wW5L.js";import{K as te}from"./chunk-6HTZNHPT-fV5RBr_f.js";import{R as x,u as A,a as ce,S as ae}from"./chunk-4TC5YS65-Do6_f7wk.js";import{ab as le,aV as de,j as n,b as ue,r as w,aw as pe,ax as me,aq as fe,v as ge,x as _e,y as he,t as F,B as N,aA as T,as as y,aB as B,aD as k}from"./index-Dj5zw04S.js";import{d as ye,c as xe}from"./chunk-GRT22PE5-CLWn4z1X.js";import"./chunk-X6BAAGCL-Cmzs-01s.js";import"./chunk-DK4WIVY6-CYCbBMOO.js";import"./Trans-55RCV8aT.js";import"./_isIndex-DSnlKWbI.js";var Se=fe({region_prices:T(y(),y().or(k()).optional()),currency_prices:T(y(),y().or(k()).optional()),conditional_region_prices:T(y(),B(D)),conditional_currency_prices:T(y(),B(D))});function Pe({shippingOption:r}){const{t:e}=ue(),{handleSuccess:p}=A(),{getIsOpen:a,setIsOpen:u}=ce(),[f,s]=w.useState(null),_=t=>{u(O,!0),s(t)},h=()=>{u(O,!1),s(null)},m=pe({defaultValues:be(r.prices),resolver:me(Se)}),{mutateAsync:o,isPending:l}=xe(r.id),{store:j,isLoading:V,isError:q,error:z}=ge(),S=w.useMemo(()=>{var t;return((t=j==null?void 0:j.supported_currencies)==null?void 0:t.map(v=>v.currency_code))||[]},[j]),{regions:g,isLoading:K,isError:G,error:$}=_e({fields:"id,name,currency_code",limit:999}),{price_preferences:H}=he({}),{setCloseOnEscape:Z}=A(),J=re({name:r.name,currencies:S,regions:g,pricePreferences:H}),Q=w.useMemo(()=>[[...S||[],...g||[]]],[S,g]),L=m.handleSubmit(async t=>{const v=Object.entries(t.currency_prices).map(([i,c])=>{if(!c||!S.some(E=>E.toLowerCase()===i.toLowerCase()))return;const d={currency_code:i,amount:R(c)},C=r.prices.find(E=>E.currency_code===i&&!E.price_rules.length);return C&&(d.id=C.id),d}).filter(i=>!!i),X=Object.entries(t.conditional_currency_prices).flatMap(([i,c])=>c==null?void 0:c.map(d=>({id:d.id,currency_code:i,amount:R(d.amount),rules:M(d)}))),Y=Object.entries(t.region_prices).map(([i,c])=>!c||!(g!=null&&g.some(C=>C.id===i))?void 0:{region_id:i,amount:R(c)}).filter(i=>!!i),ee=Object.entries(t.conditional_region_prices).flatMap(([i,c])=>c==null?void 0:c.map(d=>({id:d.id,region_id:i,amount:R(d.amount),rules:M(d)}))),se=[...v,...X,...Y,...ee];await o({prices:se},{onSuccess:()=>{F.success(e("general.success")),p()},onError:i=>{F.error(i.message)}})}),W=V||K||!S||!g;if(q)throw z;if(G)throw $;return n.jsx(x.Form,{form:m,children:n.jsxs(te,{className:"flex h-full flex-col overflow-hidden",onSubmit:L,children:[n.jsx(x.Header,{}),n.jsx(x.Body,{children:n.jsx(ae,{id:O,onOpenChangeCallback:t=>{t||s(null)},children:n.jsxs(ie,{onOpenConditionalPricesModal:_,onCloseConditionalPricesModal:h,children:[n.jsx("div",{className:"flex size-full flex-col divide-y overflow-hidden",children:n.jsx(oe,{isLoading:W,data:Q,columns:J,state:m,onEditingChange:t=>Z(!t),disableInteractions:a(O)})}),f&&n.jsx(ne,{info:f,variant:"update"})]})})}),n.jsx(x.Footer,{children:n.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[n.jsx(x.Close,{asChild:!0,children:n.jsx(N,{variant:"secondary",size:"small",children:e("actions.cancel")})}),n.jsx(N,{size:"small",className:"whitespace-nowrap",isLoading:l,onClick:L,type:"button",children:e("actions.save")})]})})]})})}var b=(r,e)=>{var a;const p=["eq","gt","lt"].includes(e)?void 0:null;return((a=r==null?void 0:r.find(u=>u.attribute===I&&u.operator===e))==null?void 0:a.value)||p},U=r=>{const e=r.price_rules||[];return{id:r.id,amount:r.amount,gte:b(e,"gte"),lte:b(e,"lte"),gt:b(e,"gt"),lt:b(e,"lt"),eq:b(e,"eq")}},be=r=>{const e=(s,_,h=[])=>{var o;const m=((o=s.price_rules)==null?void 0:o.map(l=>l.attribute))||[];return _.every(l=>m.includes(l))&&!h.some(l=>m.includes(l))},p={},a={},u={},f={};return r.forEach(s=>{var _,h,m;if(!((_=s.price_rules)!=null&&_.length)){p[s.currency_code]=s.amount;return}if(e(s,[I],[P])){const o=s.currency_code;a[o]||(a[o]=[]),a[o].push(U(s));return}if(e(s,[P],[I])){const o=(h=s.price_rules.find(l=>l.attribute===P))==null?void 0:h.value;u[o]=s.amount;return}if(e(s,[P,I])){const o=(m=s.price_rules.find(l=>l.attribute===P))==null?void 0:m.value;f[o]||(f[o]=[]),f[o].push(U(s))}}),{currency_prices:p,conditional_currency_prices:a,region_prices:u,conditional_region_prices:f}};function Ae(){const{so_id:r,location_id:e}=le();if(!r)throw de({message:"Shipping Option ID paramater is missing",status:404});const{shipping_option:p,isError:a,error:u}=ye(r,{fields:"*prices,*prices.price_rules"});if(a)throw u;return n.jsx(x,{prev:`/settings/locations/${e}`,children:p&&n.jsx(Pe,{shippingOption:p})})}export{Ae as Component};
